#!/bin/bash

# Auto-fix script for React CVE-2025-55182 (React2Shell)
# Updates vulnerable projects to React 19.2.3

PROJECTS_DIR="/Users/yeneirvine/projects"
TARGET_REACT_VERSION="19.2.3"
VULNERABLE_REACT=("19.0.0" "19.1.0" "19.1.1" "19.2.0")

echo "=================================================="
echo "React Vulnerability Auto-Fix Script"
echo "=================================================="
echo ""

UPDATED_COUNT=0
FAILED_COUNT=0
SKIPPED_COUNT=0

declare -a VULNERABLE_PROJECTS=(
    "my-website"
    "mp3-normalizer"
    "dj-friend-website"
    "runit_fe"
    "yene-website"
    "data-engineer-fullstack-test-template"
    "uto-website"
)

# Also update reliever to latest
declare -a UPDATE_PROJECTS=(
    "reliever"
)

# Function to update a project
update_project() {
    local project_name=$1
    local project_path="$PROJECTS_DIR/$project_name"
    
    echo "=========================================="
    echo "üì¶ Updating: $project_name"
    echo "Path: $project_path"
    echo "=========================================="
    
    if [[ ! -d "$project_path" ]]; then
        echo "‚ùå ERROR: Project directory not found"
        FAILED_COUNT=$((FAILED_COUNT + 1))
        return 1
    fi
    
    if [[ ! -f "$project_path/package.json" ]]; then
        echo "‚ùå ERROR: package.json not found"
        FAILED_COUNT=$((FAILED_COUNT + 1))
        return 1
    fi
    
    cd "$project_path" || {
        echo "‚ùå ERROR: Cannot change to directory"
        FAILED_COUNT=$((FAILED_COUNT + 1))
        return 1
    }
    
    echo "üîÑ Installing React $TARGET_REACT_VERSION..."
    if npm install react@$TARGET_REACT_VERSION react-dom@$TARGET_REACT_VERSION; then
        echo "‚úÖ SUCCESS: Updated to React $TARGET_REACT_VERSION"
        UPDATED_COUNT=$((UPDATED_COUNT + 1))
        
        # Verify the update
        CURRENT_REACT=$(grep -o '"react": "[^"]*"' package.json | cut -d'"' -f4 | sed 's/[\^~]//g')
        echo "   Verified: React is now $CURRENT_REACT"
    else
        echo "‚ùå FAILED: Could not update React"
        FAILED_COUNT=$((FAILED_COUNT + 1))
        return 1
    fi
    
    echo ""
}

# Update vulnerable projects
echo "üö® UPDATING VULNERABLE PROJECTS"
echo ""

for project in "${VULNERABLE_PROJECTS[@]}"; do
    update_project "$project"
done

# Update projects that need latest version
echo ""
echo "‚ö° UPDATING TO LATEST VERSION"
echo ""

for project in "${UPDATE_PROJECTS[@]}"; do
    update_project "$project"
done

# Final summary
echo "=================================================="
echo "FINAL SUMMARY"
echo "=================================================="
echo "‚úÖ Successfully Updated: $UPDATED_COUNT projects"
echo "‚ùå Failed: $FAILED_COUNT projects"
echo ""

if [[ $FAILED_COUNT -eq 0 ]]; then
    echo "üéâ All projects updated successfully!"
    echo ""
    echo "‚ö†Ô∏è  IMPORTANT NEXT STEPS:"
    echo "1. Test each project to ensure it still works"
    echo "2. Redeploy production applications"
    echo "3. Check for any breaking changes in React 19.2.3"
else
    echo "‚ö†Ô∏è  Some projects failed to update. Please check them manually."
fi
echo "=================================================="

