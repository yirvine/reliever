#!/bin/bash

# React Vulnerability Scanner for CVE-2025-55182 (React2Shell)
# Scans projects for vulnerable React/Next.js versions

PROJECTS_DIR="/Users/yeneirvine/projects"
VULNERABLE_REACT=("19.0.0" "19.1.0" "19.1.1")
AFFECTED_NEXTJS_MAJOR=("15" "16")

echo "=================================================="
echo "React Vulnerability Scanner (CVE-2025-55182)"
echo "Scanning: $PROJECTS_DIR"
echo "=================================================="
echo ""

TOTAL_PROJECTS=0
VULNERABLE_PROJECTS=0
SAFE_PROJECTS=0
NEEDS_UPDATE=0

# Find all package.json files (excluding node_modules)
while IFS= read -r package_file; do
    PROJECT_DIR=$(dirname "$package_file")
    PROJECT_NAME=$(basename "$PROJECT_DIR")
    
    # Skip node_modules directories
    if [[ "$package_file" == *"node_modules"* ]]; then
        continue
    fi
    
    TOTAL_PROJECTS=$((TOTAL_PROJECTS + 1))
    
    # Extract React and Next.js versions
    REACT_VERSION=$(grep -o '"react": "[^"]*"' "$package_file" | cut -d'"' -f4 | sed 's/[\^~]//g')
    REACT_DOM_VERSION=$(grep -o '"react-dom": "[^"]*"' "$package_file" | cut -d'"' -f4 | sed 's/[\^~]//g')
    NEXT_VERSION=$(grep -o '"next": "[^"]*"' "$package_file" | cut -d'"' -f4 | sed 's/[\^~]//g')
    
    # Skip if no React found
    if [[ -z "$REACT_VERSION" ]]; then
        continue
    fi
    
    STATUS="‚úÖ SAFE"
    VULNERABILITY_LEVEL=""
    
    # Check if React version is vulnerable
    for vuln_version in "${VULNERABLE_REACT[@]}"; do
        if [[ "$REACT_VERSION" == "$vuln_version" ]]; then
            STATUS="üö® CRITICAL - VULNERABLE"
            VULNERABILITY_LEVEL="CRITICAL"
            VULNERABLE_PROJECTS=$((VULNERABLE_PROJECTS + 1))
            break
        fi
    done
    
    # Check if using React 19.2.0 (should update to 19.2.1+)
    if [[ "$REACT_VERSION" == "19.2.0" ]]; then
        STATUS="‚ö†Ô∏è  VULNERABLE - Update to 19.2.1+"
        VULNERABILITY_LEVEL="HIGH"
        VULNERABLE_PROJECTS=$((VULNERABLE_PROJECTS + 1))
    fi
    
    # Check if using patched but older version (19.1.2, 19.0.1)
    if [[ "$REACT_VERSION" =~ ^19\.(0\.1|1\.2)$ ]]; then
        if [[ -z "$VULNERABILITY_LEVEL" ]]; then
            STATUS="‚ö° PATCHED - Consider updating to 19.2.3"
            NEEDS_UPDATE=$((NEEDS_UPDATE + 1))
        fi
    fi
    
    # If using React 19.2.1+ or 19.1.2, mark as safe
    if [[ "$REACT_VERSION" =~ ^19\.2\.[1-9]$ ]] || [[ "$REACT_VERSION" =~ ^19\.2\.[1-9][0-9]+$ ]]; then
        if [[ -z "$VULNERABILITY_LEVEL" ]]; then
            STATUS="‚úÖ SAFE - Patched version"
            SAFE_PROJECTS=$((SAFE_PROJECTS + 1))
        fi
    fi
    
    # Check if using React 18.x or earlier (not affected)
    if [[ "$REACT_VERSION" =~ ^1[0-8]\. ]] || [[ "$REACT_VERSION" =~ ^[0-9]\. ]]; then
        STATUS="‚úÖ SAFE - React 18.x or earlier (not affected)"
        SAFE_PROJECTS=$((SAFE_PROJECTS + 1))
        VULNERABILITY_LEVEL=""
    fi
    
    echo "----------------------------------------"
    echo "Project: $PROJECT_NAME"
    echo "Path: $PROJECT_DIR"
    echo "React: ${REACT_VERSION:-Not found}"
    if [[ -n "$REACT_DOM_VERSION" ]]; then
        echo "React-DOM: $REACT_DOM_VERSION"
    fi
    if [[ -n "$NEXT_VERSION" ]]; then
        echo "Next.js: $NEXT_VERSION"
        
        # Check if using App Router
        if [[ -d "$PROJECT_DIR/app" ]] || [[ -d "$PROJECT_DIR/src/app" ]]; then
            echo "App Router: ‚úÖ Detected (RSC likely in use)"
        else
            echo "App Router: ‚ùå Not detected (may be Pages Router)"
        fi
    fi
    echo "Status: $STATUS"
    echo ""
    
done < <(find "$PROJECTS_DIR" -maxdepth 3 -name "package.json" -type f)

echo "=================================================="
echo "SUMMARY"
echo "=================================================="
echo "Total Projects Scanned: $TOTAL_PROJECTS"
echo "üö® Vulnerable Projects: $VULNERABLE_PROJECTS"
echo "‚úÖ Safe Projects: $SAFE_PROJECTS"
echo "‚ö° Patched but could update: $NEEDS_UPDATE"
echo ""
echo "=================================================="
echo "RECOMMENDATIONS"
echo "=================================================="
if [[ $VULNERABLE_PROJECTS -gt 0 ]]; then
    echo "‚ùó URGENT: Update vulnerable projects immediately!"
    echo "   Run in each vulnerable project:"
    echo "   npm install react@19.2.3 react-dom@19.2.3"
    echo ""
fi
if [[ $NEEDS_UPDATE -gt 0 ]]; then
    echo "üí° RECOMMENDED: Update patched projects to latest:"
    echo "   npm update react react-dom"
    echo ""
fi
echo "=================================================="

